<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Random Street or Place Image</title>
  <style>
    body { margin: 0; background: black; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    img { max-width: 100vw; max-height: 90vh; object-fit: contain; }
    .controls { margin-top: 10px; }
    button { margin: 0 10px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

  <img id="image" alt="Loading..." />
  <div class="controls">
    <button id="back">Back</button>
    <button id="forward">Forward</button>
  </div>

  <script>
    const API_KEY = "AIzaSyC-hQJVqEkgXsqTwf-Pm-Yg_L2gPIshBYE";

    const CITIES = {
      'Tokyo': [35.60, 35.75, 139.65, 139.80],
      'Osaka': [34.65, 34.75, 135.45, 135.55],
      'Kyoto': [35.00, 35.08, 135.72, 135.80],
      'New York': [40.72, 40.78, -74.00, -73.95],
      'Paris': [48.85, 48.88, 2.33, 2.37],
      'London': [51.50, 51.52, -0.13, -0.10],
      'Berlin': [52.50, 52.52, 13.38, 13.42],
      'Seoul': [37.55, 37.57, 126.98, 127.02],
      'Singapore': [1.28, 1.30, 103.83, 103.85],
    };

    const links = [];
    let currentIndex = 0;

    function randomCoords(bbox) {
      const [latMin, latMax, lonMin, lonMax] = bbox;
      const lat = (Math.random() * (latMax - latMin)) + latMin;
      const lon = (Math.random() * (lonMax - lonMin)) + lonMin;
      return [lat, lon];
    }

    async function isStreetViewAvailable(lat, lon) {
      const url = `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&key=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.status === "OK";
    }

    function makeStreetViewURL(lat, lon) {
      const heading = Math.floor(Math.random() * 360);
      const pitch = Math.floor(Math.random() * 20 - 10);
      const fov = Math.floor(Math.random() * 20 + 70);
      return `https://maps.googleapis.com/maps/api/streetview?size=1600x900&location=${lat},${lon}&heading=${heading}&pitch=${pitch}&fov=${fov}&key=${API_KEY}`;
    }

    async function getPlacePhotoURL(lat, lon) {
      const nearbySearch = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lon}&radius=150&type=point_of_interest&key=${API_KEY}`;
      const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(nearbySearch)}`);
      const data = await response.json();
      const candidates = data.results?.filter(r => r.photos)?.map(r => r.photos[0].photo_reference);
      if (!candidates || candidates.length === 0) return null;
      const ref = candidates[Math.floor(Math.random() * candidates.length)];
      return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=1600&photoreference=${ref}&key=${API_KEY}`;
    }

    async function generateImageURL() {
      for (let i = 0; i < 10; i++) {
        const [city, bbox] = Object.entries(CITIES)[Math.floor(Math.random() * Object.keys(CITIES).length)];
        const [lat, lon] = randomCoords(bbox);

        if (Math.random() < 0.5) {
          if (await isStreetViewAvailable(lat, lon)) {
            return makeStreetViewURL(lat, lon);
          }
        } else {
          const url = await getPlacePhotoURL(lat, lon);
          if (url) return url;
        }
      }
      return null;
    }

    async function preloadImages(n = 5) {
      for (let i = 0; i < n; i++) {
        const url = await generateImageURL();
        if (url) links.push(url);
      }
      showImage(currentIndex);
    }

    function showImage(index) {
      const img = document.getElementById("image");
      if (!links.length) {
        img.alt = "No images loaded";
        return;
      }
      img.src = links[index];
    }

    document.getElementById("forward").addEventListener("click", () => {
      currentIndex = (currentIndex + 1) % links.length;
      showImage(currentIndex);
    });

    document.getElementById("back").addEventListener("click", () => {
      currentIndex = (currentIndex - 1 + links.length) % links.length;
      showImage(currentIndex);
    });

    preloadImages();
  </script>
</body>
</html>

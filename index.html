<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta charset="UTF-8" />
  <title>Random Image Navigator</title>
  <style>
    body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      font-family: sans-serif;
      display: flex; justify-content: center; align-items: center;
      height: 100vh; overflow: hidden;
    }
    img {
      max-width: 90vw; max-height: 90vh;
      border: 3px solid #fff;
      border-radius: 8px;
    }
    button {
      position: fixed; bottom: 20px;
      font-size: 3em; padding: 0.1em 0.3em;
      cursor: pointer; border-radius: 5px; border: none;
      background: rgba(30,30,30,0.8); color: #fff;
      user-select: none; z-index: 1000;
    }
    button:disabled { opacity: 0.3; cursor: default; }
    button:hover:not(:disabled) { background: rgba(70,70,70,0.9); }
    #backBtn { left: 20px; }
    #forwardBtn { right: 20px; }
    button { touch-action: manipulation; }
  </style>
</head>
<body>

<img id="mainImage" src="" alt="Random Image" />
<button id="backBtn" disabled aria-label="Previous image">&lt;</button>
<button id="forwardBtn" disabled aria-label="Next image">&gt;</button>

<script>
const CITIES = {
  "Tokyo": [35.60, 35.75, 139.65, 139.80],
  "Osaka": [34.65, 34.75, 135.45, 135.55],
  "Kyoto": [35.00, 35.08, 135.72, 135.80],
  "New York": [40.72, 40.78, -74.00, -73.95],
  "Los Angeles": [34.04, 34.10, -118.27, -118.20],
  "Paris": [48.85, 48.88, 2.33, 2.37],
  "London": [51.50, 51.52, -0.13, -0.10],
  "Berlin": [52.50, 52.52, 13.38, 13.42],
  "Seoul": [37.55, 37.57, 126.98, 127.02],
  "Singapore": [1.28, 1.30, 103.83, 103.85],
  "Melbourne": [-37.82, -37.80, 144.96, 145.00],
  "Hanoi": [21.01, 21.03, 105.83, 105.85],
  "Mexico City": [19.42, 19.44, -99.15, -99.12],
  "Delhi": [28.61, 28.63, 77.21, 77.24],
  "Jakarta": [-6.21, -6.19, 106.82, 106.85],
  "Cairo": [30.04, 30.06, 31.22, 31.25],
  "Istanbul": [41.01, 41.03, 28.97, 29.00],
  "Sydney": [-33.87, -33.85, 151.20, 151.22],
};

function getRandomCoord(bbox) {
  const [latMin, latMax, lonMin, lonMax] = bbox;
  const lat = Math.random() * (latMax - latMin) + latMin;
  const lon = Math.random() * (lonMax - lonMin) + lonMin;
  return [lat, lon];
}

function generateStreetViewUrl(lat, lon) {
  const heading = Math.floor(Math.random() * 360);
  const pitch = Math.floor(Math.random() * 20 - 10);
  const fov = Math.floor(Math.random() * 20 + 70);
  return `https://maps.googleapis.com/maps/api/streetview?size=800x600&location=${lat},${lon}&heading=${heading}&pitch=${pitch}&fov=${fov}&key=AIzaSyC-hQJVqEkgXsqTwf-Pm-Yg_L2gPIshBYE`;
}

async function preloadValidImageUrl(retries = 10) {
  for (let attempt = 0; attempt < retries; attempt++) {
    const cityKeys = Object.keys(CITIES);
    const city = cityKeys[Math.floor(Math.random() * cityKeys.length)];
    const [lat, lon] = getRandomCoord(CITIES[city]);
    const url = generateStreetViewUrl(lat, lon);

    try {
      const res = await fetch(url, { method: 'HEAD' });
      if (res.ok) return url;
    } catch (err) {}
  }
  return null;
}

let links = [];
let currentIndex = -1;
let historyStack = [];
let forwardStack = [];
const maxHistory = 3;
const maxPreload = 5;

const imgElement = document.getElementById('mainImage');
const backBtn = document.getElementById('backBtn');
const forwardBtn = document.getElementById('forwardBtn');

function updateButtons() {
  backBtn.disabled = historyStack.length === 0;
  forwardBtn.disabled = forwardStack.length === 0;
}

async function preloadForwardImages() {
  forwardStack = [];
  while (forwardStack.length < maxPreload) {
    const link = await preloadValidImageUrl();
    if (link && !links.includes(link)) {
      links.push(link);
      forwardStack.push(links.length - 1);
    }
  }
  updateButtons();
}

function showImage(index) {
  currentIndex = index;
  imgElement.src = links[currentIndex];
  imgElement.alt = `Image ${currentIndex + 1}`;
  preloadForwardImages();
  updateButtons();
}

backBtn.addEventListener('click', () => {
  if (historyStack.length > 0) {
    forwardStack.unshift(currentIndex);
    if (forwardStack.length > maxPreload) forwardStack.pop();
    const prevIndex = historyStack.pop();
    showImage(prevIndex);
  }
});

forwardBtn.addEventListener('click', () => {
  if (forwardStack.length > 0) {
    historyStack.push(currentIndex);
    if (historyStack.length > maxHistory) historyStack.shift();
    const nextIndex = forwardStack.shift();
    showImage(nextIndex);
  }
});

(async () => {
  for (let i = 0; i < maxPreload; i++) {
    const link = await preloadValidImageUrl();
    if (link) links.push(link);
  }
  if (links.length === 0) {
    imgElement.alt = "Failed to load any images.";
    return;
  }
  currentIndex = 0;
  showImage(currentIndex);
})();
</script>

</body>
</html>

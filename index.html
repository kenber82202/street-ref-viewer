<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Random Image Navigator</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    img {
      max-width: 90vw;
      max-height: 90vh;
      border: 3px solid #fff;
      border-radius: 8px;
    }
    button {
      position: fixed;
      bottom: 20px;
      font-size: 3em;
      padding: 0.1em 0.3em;
      cursor: pointer;
      border-radius: 5px;
      border: none;
      background: rgba(30,30,30,0.8);
      color: #fff;
      z-index: 1000;
      touch-action: manipulation;
    }
    button:disabled {
      opacity: 0.3;
      cursor: default;
    }
    button:hover:not(:disabled) {
      background: rgba(70,70,70,0.9);
    }
    #backBtn { left: 20px; }
    #forwardBtn { right: 20px; }
  </style>
</head>
<body>

<img id="mainImage" src="" alt="Random Image" />
<button id="backBtn" disabled aria-label="Previous image">&lt;</button>
<button id="forwardBtn" disabled aria-label="Next image">&gt;</button>

<script>
const API_KEY = 'YOUR_GOOGLE_API_KEY'; // Replace with your API key

// Global city dataset with tighter bounding boxes
const CITIES = {
  'Tokyo': [35.60, 35.75, 139.65, 139.80],
  'Osaka': [34.65, 34.75, 135.45, 135.55],
  'Kyoto': [35.00, 35.08, 135.72, 135.80],
  'New York': [40.72, 40.78, -74.00, -73.95],
  'Paris': [48.85, 48.88, 2.33, 2.37],
  'London': [51.50, 51.52, -0.13, -0.10],
  'Berlin': [52.50, 52.52, 13.38, 13.42],
  'Seoul': [37.55, 37.57, 126.98, 127.02],
  'Singapore': [1.28, 1.30, 103.83, 103.85],
  'Delhi': [28.61, 28.63, 77.21, 77.24],
};

function randomCoords([latMin, latMax, lonMin, lonMax]) {
  const lat = (Math.random() * (latMax - latMin) + latMin).toFixed(6);
  const lon = (Math.random() * (lonMax - lonMin) + lonMin).toFixed(6);
  return [lat, lon];
}

// Try to get a valid Street View URL with retries
async function streetViewURL(retries = 10) {
  for (let i = 0; i < retries; i++) {
    // Pick a random city and generate random coords
    const [city, bbox] = Object.entries(CITIES)[Math.floor(Math.random() * Object.keys(CITIES).length)];
    const [lat, lon] = randomCoords(bbox);
    const metaURL = `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&key=${API_KEY}`;
    try {
      const metaRes = await fetch(metaURL);
      const metaData = await metaRes.json();
      if (metaData.status === 'OK') {
        const heading = Math.floor(Math.random() * 360);
        const pitch = Math.floor(Math.random() * 20 - 10); // -10 to 10
        const fov = Math.floor(Math.random() * 20 + 70);     // 70 to 90
        console.log(`Street View from ${city} at [${lat}, ${lon}] chosen.`);
        return `https://maps.googleapis.com/maps/api/streetview?size=1600x900&location=${lat},${lon}&heading=${heading}&pitch=${pitch}&fov=${fov}&key=${API_KEY}`;
      }
    } catch (err) {
      console.error("Street View error:", err);
    }
  }
  return null;
}

// Try to get a valid Place Photo URL with retries
async function placePhotoURL(retries = 10) {
  for (let i = 0; i < retries; i++) {
    const [city, bbox] = Object.entries(CITIES)[Math.floor(Math.random() * Object.keys(CITIES).length)];
    const [lat, lon] = randomCoords(bbox);
    const placeURL = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lon}&radius=150&type=point_of_interest&key=${API_KEY}`;
    try {
      const placeRes = await fetch(placeURL);
      const placeData = await placeRes.json();
      if (placeData.results && placeData.results.length > 0) {
        // Look for a place with photos
        const place = placeData.results.find(p => p.photos && p.photos.length > 0);
        if (place) {
          const photoRef = place.photos[0].photo_reference;
          console.log(`Place Photo from ${city} at [${lat}, ${lon}] chosen.`);
          return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=1600&photoreference=${photoRef}&key=${API_KEY}`;
        }
      }
    } catch (err) {
      console.error("Place Photo error:", err);
    }
  }
  return null;
}

// Generate one valid random image URL, with a 50/50 branch decision
async function generateImageURL() {
  // Choose branch once
  const useStreet = Math.random() < 0.5;
  let url;
  if (useStreet) {
    console.log("Trying Street View first.");
    url = await streetViewURL();
    if (!url) {
      console.log("Street View failed; falling back to Place Photo.");
      url = await placePhotoURL();
    }
  } else {
    console.log("Trying Place Photo first.");
    url = await placePhotoURL();
    if (!url) {
      console.log("Place Photo failed; falling back to Street View.");
      url = await streetViewURL();
    }
  }
  return url;
}

// ----- App State and Navigation Logic -----
let links = [];
let currentIndex = -1;
let historyStack = [];
let forwardStack = [];
const maxHistory = 3;
const maxPreload = 3;

const imgElement = document.getElementById('mainImage');
const backBtn = document.getElementById('backBtn');
const forwardBtn = document.getElementById('forwardBtn');

function updateButtons() {
  backBtn.disabled = historyStack.length === 0;
  forwardBtn.disabled = forwardStack.length === 0;
}

function showImage(index) {
  currentIndex = index;
  imgElement.src = links[currentIndex];
  imgElement.alt = `Image ${currentIndex + 1} of ${links.length}`;
  preloadForwardImages();
  updateButtons();
}

backBtn.addEventListener('click', () => {
  if (historyStack.length > 0) {
    forwardStack.unshift(currentIndex);
    if (forwardStack.length > maxPreload) forwardStack.pop();
    const prevIndex = historyStack.pop();
    showImage(prevIndex);
  }
});

forwardBtn.addEventListener('click', () => {
  if (forwardStack.length > 0) {
    historyStack.push(currentIndex);
    if (historyStack.length > maxHistory) historyStack.shift();
    const nextIndex = forwardStack.shift();
    showImage(nextIndex);
  }
});

function preloadForwardImages() {
  // Rebuild the forward stack with new preloaded images
  forwardStack = [];
  for (let i = 0; i < maxPreload; i++) {
    generateImageURL().then(url => {
      if (url) {
        links.push(url);
        const index = links.length - 1;
        const img = new Image();
        img.onload = () => {
          forwardStack.push(index);
          updateButtons();
        };
        img.src = url;
      }
    });
  }
}

// ----- On-load: Preload 5 images -----
(async () => {
  for (let i = 0; i < 5; i++) {
    const url = await generateImageURL();
    if (url) links.push(url);
  }
  if (links.length > 0) {
    currentIndex = 0;
    showImage(currentIndex);
  } else {
    imgElement.alt = "Failed to load any images.";
  }
})();
</script>
</body>
</html>
